# True VAR Emitter Predictor

åŸºäºVAR (Visual AutoRegressive) æ ¸å¿ƒæ€æƒ³çš„é«˜åˆ†è¾¨ç‡ç»“æ„åŒ–emitteré¢„æµ‹æ¨¡å‹ã€‚æœ¬å®ç°å……åˆ†åˆ©ç”¨VARçš„"ä¸‹ä¸€å°ºåº¦é¢„æµ‹"æœºåˆ¶ï¼Œå®ç°ä»ä½åˆ†è¾¨ç‡è¾“å…¥åˆ°é«˜åˆ†è¾¨ç‡ç»“æ„åŒ–ä¿¡æ¯çš„æ¸è¿›å¼é¢„æµ‹ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. çœŸæ­£çš„VARæ¶æ„å®ç°
- **æ¸è¿›å¼æ®‹å·®ç´¯ç§¯**: å®ç°VARçš„æ ¸å¿ƒPhiæ®‹å·®ç½‘ç»œå’Œå¤šå°ºåº¦ç‰¹å¾èåˆ
- **ä¸‹ä¸€å°ºåº¦é¢„æµ‹**: é‡‡ç”¨"next-scale prediction"è€Œéä¼ ç»Ÿçš„"next-token prediction"
- **è‡ªå›å½’å°ºåº¦ç”Ÿæˆ**: ä»ä½åˆ†è¾¨ç‡é€æ­¥ç”Ÿæˆé«˜åˆ†è¾¨ç‡ç»“æ„åŒ–ä¿¡æ¯

### 2. å¤šå°ºåº¦æ¸è¿›å¼é¢„æµ‹
- **å°ºåº¦åºåˆ—**: 10Ã—10 â†’ 20Ã—20 â†’ 40Ã—40 â†’ 80Ã—80
- **æ— å¼ºåˆ¶ä¸‹é‡‡æ ·**: ä¿æŒè¾“å…¥åˆ†è¾¨ç‡ï¼Œé¿å…ä¿¡æ¯ä¸¢å¤±
- **æ®‹å·®ç´¯ç§¯æœºåˆ¶**: é€šè¿‡Phiç½‘ç»œå®ç°è·¨å°ºåº¦ç‰¹å¾ç´¯ç§¯

### 3. é«˜åˆ†è¾¨ç‡ç»“æ„åŒ–è¾“å‡º
- **è®­ç»ƒåˆ†è¾¨ç‡**: 160Ã—160
- **æ¨ç†èƒ½åŠ›**: 40Ã—40 â†’ 80Ã—80 (å¯æ‰©å±•åˆ°æ›´é«˜åˆ†è¾¨ç‡)
- **ç»“æ„åŒ–é¢„æµ‹**: åŒæ—¶é¢„æµ‹emitteræ¦‚ç‡å›¾å’Œç²¾ç¡®ä½ç½®

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

#### 1. EmitterVectorQuantizer
```python
class EmitterVectorQuantizer(nn.Module):
    def get_next_autoregressive_input(self, si, SN, f_hat, h_BChw):
        """VARçš„æ ¸å¿ƒæ®‹å·®ç´¯ç§¯æœºåˆ¶"""
        # å®ç°æ¸è¿›å¼æ®‹å·®ç´¯ç§¯å’Œä¸‹ä¸€å°ºåº¦è¾“å…¥ç”Ÿæˆ
```

#### 2. AdaLNSelfAttn (VAR Transformer Block)
```python
class AdaLNSelfAttn(nn.Module):
    """VARçš„è‡ªé€‚åº”å±‚å½’ä¸€åŒ–è‡ªæ³¨æ„åŠ›æœºåˆ¶"""
    # æ”¯æŒå°ºåº¦æ¡ä»¶çš„Transformerå—
```

#### 3. TrueVAREmitterPredictor
```python
class TrueVAREmitterPredictor(nn.Module):
    """çœŸæ­£çš„VAR emitteré¢„æµ‹å™¨"""
    def autoregressive_inference(self, x, target_resolution):
        """VARé£æ ¼çš„è‡ªå›å½’æ¨ç†"""
```

### å…³é”®è®¾è®¡åŸåˆ™

1. **æ— ä¸‹é‡‡æ ·ç¼–ç **: ä¿æŒè¾“å…¥åˆ†è¾¨ç‡ï¼Œé¿å…ä¿¡æ¯ä¸¢å¤±
2. **æ¸è¿›å¼ç‰¹å¾èåˆ**: é€šè¿‡æ®‹å·®ç´¯ç§¯å®ç°å¤šå°ºåº¦ä¿¡æ¯æ•´åˆ
3. **å°ºåº¦æ¡ä»¶ç”Ÿæˆ**: æ¯ä¸ªå°ºåº¦éƒ½æœ‰ä¸“é—¨çš„é¢„æµ‹å¤´å’Œæ¡ä»¶åµŒå…¥
4. **VARè‡ªå›å½’æœºåˆ¶**: å®ç°çœŸæ­£çš„"ä¸‹ä¸€å°ºåº¦é¢„æµ‹"

## ğŸ“Š ä¸åŸå§‹å®ç°çš„å¯¹æ¯”

| ç‰¹æ€§ | åŸå§‹å®ç° | TrueVARå®ç° |
|------|----------|-------------|
| ç¼–ç å™¨ | 4å€ä¸‹é‡‡æ · | æ— ä¸‹é‡‡æ · |
| ç‰¹å¾èåˆ | ç®€å•ä¸Šé‡‡æ · | VARæ®‹å·®ç´¯ç§¯ |
| é¢„æµ‹æœºåˆ¶ | ç‹¬ç«‹å°ºåº¦é¢„æµ‹ | è‡ªå›å½’å°ºåº¦é¢„æµ‹ |
| åˆ†è¾¨ç‡èƒ½åŠ› | å—é™äºç¼–ç å™¨ | çœŸæ­£é«˜åˆ†è¾¨ç‡ |
| VARæ ¸å¿ƒæ€æƒ³ | æœªå……åˆ†åˆ©ç”¨ | å®Œå…¨å®ç° |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. è®­ç»ƒ

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶è®­ç»ƒ
python train_true_var.py --config config_true_var.json
```

è®­ç»ƒé…ç½®:
- **è¾“å…¥åˆ†è¾¨ç‡**: 160Ã—160
- **ç›®æ ‡å°ºåº¦**: [10, 20, 40, 80]
- **æ‰¹æ¬¡å¤§å°**: 8
- **å­¦ä¹ ç‡**: 1e-4 (å¸¦warmup)

### 2. æ¨ç†

```bash
# æ¸è¿›å¼å¤šå°ºåº¦é¢„æµ‹
python inference_true_var.py --model best_model.pt --mode progressive

# è¶…åˆ†è¾¨ç‡é¢„æµ‹ (40x40 -> 80x80)
python inference_true_var.py --model best_model.pt --mode super_resolution --target_res 80

# ä¸¤ç§æ¨¡å¼éƒ½è¿è¡Œ
python inference_true_var.py --model best_model.pt --mode both
```

### 3. ä»£ç ç¤ºä¾‹

```python
from var_emitter_model_true import TrueVAREmitterPredictor

# åˆå§‹åŒ–æ¨¡å‹
model = TrueVAREmitterPredictor(
    patch_nums=(10, 20, 40, 80),
    embed_dim=768,
    num_heads=12,
    num_layers=24
)

# æ¸è¿›å¼é¢„æµ‹
input_image = torch.randn(1, 1, 160, 160)
outputs = model(input_image)

# è¶…åˆ†è¾¨ç‡æ¨ç†
low_res_input = torch.randn(1, 1, 40, 40)
high_res_output = model.autoregressive_inference(low_res_input, target_resolution=80)
```

## ğŸ”¬ æŠ€æœ¯ç»†èŠ‚

### VARæ®‹å·®ç´¯ç§¯æœºåˆ¶

```python
def get_next_autoregressive_input(self, si, SN, f_hat, h_BChw):
    """VARçš„æ ¸å¿ƒæœºåˆ¶"""
    max_HW = self.patch_nums[-1]
    
    if si != SN - 1:
        # åº”ç”¨Phiæ®‹å·®ç½‘ç»œ
        h = self.quant_resi[si](F.interpolate(h_BChw, size=(max_HW, max_HW), mode='bicubic'))
        f_hat.add_(h)  # æ®‹å·®ç´¯ç§¯
        # å‡†å¤‡ä¸‹ä¸€å°ºåº¦è¾“å…¥
        next_input = F.interpolate(f_hat, size=(self.patch_nums[si+1], self.patch_nums[si+1]), mode='area')
        return f_hat, next_input
```

### å¤šå°ºåº¦æŸå¤±å‡½æ•°

```python
class VAREmitterLoss(nn.Module):
    def __init__(self, scale_weights=[0.5, 0.7, 0.9, 1.0]):
        # ä¸åŒå°ºåº¦ä½¿ç”¨ä¸åŒæƒé‡ï¼Œé«˜åˆ†è¾¨ç‡æƒé‡æ›´å¤§
```

### è‡ªé€‚åº”ä½ç½®ç¼–ç 

```python
# æ¯ä¸ªå°ºåº¦éƒ½æœ‰ç‹¬ç«‹çš„ä½ç½®ç¼–ç 
self.pos_embeds = nn.ParameterList([
    nn.Parameter(torch.zeros(1, pn * pn, embed_dim))
    for pn in patch_nums
])
```

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### 1. æ¸è¿›å¼åˆ†è¾¨ç‡æå‡
- 10Ã—10: ç²—ç•¥ç»“æ„æ£€æµ‹
- 20Ã—20: ä¸­ç­‰ç²¾åº¦å®šä½
- 40Ã—40: ç²¾ç»†ç»“æ„è¯†åˆ«
- 80Ã—80: é«˜ç²¾åº¦emitteré¢„æµ‹

### 2. è¶…åˆ†è¾¨ç‡èƒ½åŠ›
- è¾“å…¥: 40Ã—40 ä½åˆ†è¾¨ç‡å›¾åƒ
- è¾“å‡º: 80Ã—80 é«˜åˆ†è¾¨ç‡ç»“æ„åŒ–é¢„æµ‹
- ä¿æŒç»“æ„ä¸€è‡´æ€§å’Œç»†èŠ‚å¢å¼º

### 3. VARä¼˜åŠ¿ä½“ç°
- **ç»“æ„åŒ–ç”Ÿæˆ**: æ¯”ä¼ ç»Ÿæ–¹æ³•æ›´å¥½çš„ç»“æ„ä¿æŒ
- **æ¸è¿›å¼ç»†åŒ–**: ä»ç²—åˆ°ç»†çš„è‡ªç„¶ç”Ÿæˆè¿‡ç¨‹
- **å¯æ‰©å±•æ€§**: æ˜“äºæ‰©å±•åˆ°æ›´é«˜åˆ†è¾¨ç‡

## ğŸ”§ é…ç½®è¯´æ˜

### æ¨¡å‹é…ç½® (config_true_var.json)

```json
{
  "model": {
    "patch_nums": [10, 20, 40, 80],  // VARå°ºåº¦åºåˆ—
    "embed_dim": 768,               // åµŒå…¥ç»´åº¦
    "num_heads": 12,                // æ³¨æ„åŠ›å¤´æ•°
    "num_layers": 24,               // Transformerå±‚æ•°
    "vocab_size": 8192              // é‡åŒ–è¯æ±‡è¡¨å¤§å°
  },
  "training": {
    "input_resolution": [160, 160],  // è®­ç»ƒè¾“å…¥åˆ†è¾¨ç‡
    "target_resolutions": {          // å¤šå°ºåº¦ç›®æ ‡
      "target_10": [10, 10],
      "target_20": [20, 20],
      "target_40": [40, 40],
      "target_80": [80, 80]
    }
  }
}
```

## ğŸ¯ æ ¸å¿ƒåˆ›æ–°ç‚¹

1. **çœŸæ­£çš„VARå®ç°**: å®Œå…¨éµå¾ªVARçš„"ä¸‹ä¸€å°ºåº¦é¢„æµ‹"èŒƒå¼
2. **æ— ä¿¡æ¯ä¸¢å¤±**: ç§»é™¤å¼ºåˆ¶ä¸‹é‡‡æ ·ï¼Œä¿æŒå®Œæ•´è¾“å…¥ä¿¡æ¯
3. **æ¸è¿›å¼æ®‹å·®ç´¯ç§¯**: å®ç°VARçš„æ ¸å¿ƒPhiç½‘ç»œæœºåˆ¶
4. **å¤šå°ºåº¦è‡ªå›å½’**: çœŸæ­£çš„å°ºåº¦æ¡ä»¶ç”Ÿæˆ
5. **é«˜åˆ†è¾¨ç‡èƒ½åŠ›**: æ”¯æŒä»ä½åˆ†è¾¨ç‡åˆ°é«˜åˆ†è¾¨ç‡çš„ç»“æ„åŒ–é¢„æµ‹

## ğŸ“ æ€»ç»“

æœ¬å®ç°å……åˆ†åˆ©ç”¨äº†VARçš„æ ¸å¿ƒæ€æƒ³ï¼Œé€šè¿‡"ä¸‹ä¸€å°ºåº¦é¢„æµ‹"æœºåˆ¶å®ç°äº†çœŸæ­£çš„é«˜åˆ†è¾¨ç‡ç»“æ„åŒ–ä¿¡æ¯é¢„æµ‹ã€‚ç›¸æ¯”åŸå§‹å®ç°ï¼Œæ–°æ¶æ„:

- âœ… å®ç°äº†çœŸæ­£çš„VARæ®‹å·®ç´¯ç§¯æœºåˆ¶
- âœ… æ”¯æŒæ¸è¿›å¼å¤šå°ºåº¦é¢„æµ‹
- âœ… å…·å¤‡è¶…åˆ†è¾¨ç‡ç”Ÿæˆèƒ½åŠ›
- âœ… ä¿æŒäº†ç»“æ„åŒ–ä¿¡æ¯çš„ä¸€è‡´æ€§
- âœ… å¯æ‰©å±•åˆ°æ›´é«˜åˆ†è¾¨ç‡

è¿™æ˜¯ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„VAR emitteré¢„æµ‹å™¨ï¼Œèƒ½å¤Ÿä»40Ã—40çš„ä½åˆ†è¾¨ç‡è¾“å…¥ç”Ÿæˆ80Ã—80ç”šè‡³æ›´é«˜åˆ†è¾¨ç‡çš„ç»“æ„åŒ–emitteræ¦‚ç‡å›¾ã€‚