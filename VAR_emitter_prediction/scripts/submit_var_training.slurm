#!/bin/bash
#SBATCH --job-name=var_emitter_training
#SBATCH --output=var_training_%j.out
#SBATCH --error=var_training_%j.err
#SBATCH --time=12:00:00
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=64G
#SBATCH --partition=cpu1
#SBATCH --gres=gpu:1

# è®¾ç½®å·¥ä½œç›®å½•
WORK_DIR="/home/guest/Others/DECODE_rewrite/VAR_emitter_prediction"
cd $WORK_DIR

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# æ¿€æ´»condaç¯å¢ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
# source /path/to/conda/etc/profile.d/conda.sh
# conda activate your_env_name

# è®¾ç½®Pythonè·¯å¾„
export PYTHONPATH="${PYTHONPATH}:/home/guest/Others/DECODE_rewrite"

# è®°å½•å¼€å§‹æ—¶é—´å’Œç³»ç»Ÿä¿¡æ¯
echo "ä½œä¸šå¼€å§‹æ—¶é—´: $(date)"
echo "èŠ‚ç‚¹ä¿¡æ¯: $(hostname)"
echo "GPUä¿¡æ¯:"
nvidia-smi
echo "å†…å­˜ä¿¡æ¯:"
free -h
echo "CPUä¿¡æ¯:"
lscpu | grep "Model name"
echo "========================================"

# è®¾ç½®æ•°æ®è·¯å¾„ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
TIFF_DIR="/home/guest/Others/DECODE_rewrite/simulation_zmap2tiff_var_highres/outputs_100samples_160"
EMITTER_DIR="/home/guest/Others/DECODE_rewrite/simulation_zmap2tiff_var_highres/outputs_100samples_160"
OUTPUT_DIR="./training_outputs"

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p $OUTPUT_DIR
mkdir -p $OUTPUT_DIR/tensorboard

# æ™ºèƒ½ç«¯å£æ£€æµ‹å‡½æ•°
find_available_port() {
    local start_port=6006
    local max_port=6020
    
    for ((port=start_port; port<=max_port; port++)); do
        if ! netstat -tuln 2>/dev/null | grep -q ":$port " && ! ss -tuln 2>/dev/null | grep -q ":$port "; then
            echo $port
            return 0
        fi
    done
    return 1
}

# å¯åŠ¨TensorBoardç›‘æ§
echo "ğŸš€ å¯åŠ¨TensorBoardç›‘æ§..."
AVAILABLE_PORT=$(find_available_port)
if [ $? -eq 0 ] && [ -n "$AVAILABLE_PORT" ]; then
    echo "âœ… æ‰¾åˆ°å¯ç”¨ç«¯å£: $AVAILABLE_PORT"
    tensorboard --logdir=$OUTPUT_DIR/tensorboard --host=0.0.0.0 --port=$AVAILABLE_PORT --reload_interval=10 &
    TENSORBOARD_PID=$!
    echo "ğŸ“Š TensorBoardå·²å¯åŠ¨ (PID: $TENSORBOARD_PID)"
    echo "ğŸŒ è®¿é—®åœ°å€: http://localhost:$AVAILABLE_PORT"
    echo "ğŸ”— è¿œç¨‹è®¿é—®: ssh -L $AVAILABLE_PORT:localhost:$AVAILABLE_PORT user@server"
else
    echo "âŒ ç«¯å£6006-6020å‡è¢«å ç”¨ï¼ŒTensorBoardå¯åŠ¨å¤±è´¥"
    TENSORBOARD_PID=""
fi

# è¿è¡ŒVARæ¨¡å‹è®­ç»ƒ
echo "å¼€å§‹è®­ç»ƒVARæ¨¡å‹..."
python train_true_var.py \
    --config config_true_var_slurm.json

# æ£€æŸ¥é€€å‡ºçŠ¶æ€
TRAIN_EXIT_CODE=$?
if [ $TRAIN_EXIT_CODE -eq 0 ]; then
    echo "========================================"
    echo "âœ… VARæ¨¡å‹è®­ç»ƒæˆåŠŸå®Œæˆ!"
    echo "å®Œæˆæ—¶é—´: $(date)"
    
    # æ˜¾ç¤ºè¾“å‡ºç›®å½•ç»Ÿè®¡
    echo "è¾“å‡ºç›®å½•ç»Ÿè®¡:"
    if [ -d "$OUTPUT_DIR" ]; then
        echo "æ¨¡å‹æ–‡ä»¶: $(ls -1 $OUTPUT_DIR/*.pth 2>/dev/null | wc -l)"
        echo "æ—¥å¿—æ–‡ä»¶: $(ls -1 $OUTPUT_DIR/logs 2>/dev/null | wc -l)"
        echo "æ€»å¤§å°: $(du -sh $OUTPUT_DIR 2>/dev/null | cut -f1)"
    fi
    
    # æ˜¾ç¤ºæœ€ç»ˆæ¨¡å‹ä¿¡æ¯
    echo "æœ€æ–°æ£€æŸ¥ç‚¹:"
    ls -la $OUTPUT_DIR/checkpoint_*.pth 2>/dev/null | tail -1
    
    # TensorBoardä¿¡æ¯
    if [ -n "$TENSORBOARD_PID" ] && kill -0 $TENSORBOARD_PID 2>/dev/null; then
        echo "ğŸ“Š TensorBoardä»åœ¨è¿è¡Œ (PID: $TENSORBOARD_PID, ç«¯å£: $AVAILABLE_PORT)"
        echo "ğŸŒ æŸ¥çœ‹è®­ç»ƒç»“æœ: http://localhost:$AVAILABLE_PORT"
        echo "ğŸ’¡ åœæ­¢TensorBoard: kill $TENSORBOARD_PID"
    fi
else
    echo "âŒ è®­ç»ƒå¤±è´¥ï¼Œé€€å‡ºç : $TRAIN_EXIT_CODE"
    echo "è¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—: logs/var_training_${SLURM_JOB_ID}.err"
fi

# æ¸…ç†å‡½æ•°
cleanup() {
    echo "ğŸ§¹ æ¸…ç†èµ„æº..."
    if [ -n "$TENSORBOARD_PID" ] && kill -0 $TENSORBOARD_PID 2>/dev/null; then
        echo "ğŸ›‘ åœæ­¢TensorBoard (PID: $TENSORBOARD_PID)"
        kill $TENSORBOARD_PID 2>/dev/null
        sleep 2
        if kill -0 $TENSORBOARD_PID 2>/dev/null; then
            kill -9 $TENSORBOARD_PID 2>/dev/null
        fi
    fi
}

# è®¾ç½®ä¿¡å·å¤„ç†
trap cleanup EXIT INT TERM

echo "ä½œä¸šç»“æŸæ—¶é—´: $(date)"
echo "========================================"
echo "ğŸ“‹ ä»»åŠ¡æ‘˜è¦:"
echo "   - è®­ç»ƒçŠ¶æ€: $([ $TRAIN_EXIT_CODE -eq 0 ] && echo 'æˆåŠŸ' || echo 'å¤±è´¥')"
echo "   - è¾“å‡ºç›®å½•: $OUTPUT_DIR"
echo "   - TensorBoard: $([ -n '$TENSORBOARD_PID' ] && echo 'å·²å¯åŠ¨' || echo 'æœªå¯åŠ¨')"
echo "   - æ—¥å¿—æ–‡ä»¶: logs/var_training_${SLURM_JOB_ID}.out"
echo "========================================"