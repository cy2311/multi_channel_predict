# æ‰¹é‡TIFFç”ŸæˆæŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä½¿ç”¨ä¼˜åŒ–åçš„æ‰¹é‡TIFFç”ŸæˆåŠŸèƒ½ï¼Œä¸€æ¬¡æ€§ç”Ÿæˆå¤šä¸ªä¸åŒå‚æ•°é…ç½®çš„TIFFæ–‡ä»¶ã€‚

## ä¸»è¦ç‰¹æ€§

### ğŸš€ æ€§èƒ½ä¼˜åŒ–
- **å¹¶è¡Œå¤„ç†**: æ”¯æŒå¤šè¿›ç¨‹å¹¶è¡Œç”Ÿæˆï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPU
- **å†…å­˜ä¼˜åŒ–**: æ¯ä¸ªä½œä¸šç‹¬ç«‹è¿è¡Œï¼Œé¿å…å†…å­˜ç´¯ç§¯ï¼Œæ”¯æŒæµå¼å¤„ç†
- **ç›´æ¥æ¸²æŸ“**: é»˜è®¤ä½¿ç”¨ç›´æ¥æ¸²æŸ“ï¼Œé¿å…é«˜åˆ†è¾¨ç‡æ¸²æŸ“å’Œé™é‡‡æ ·
- **å¯æ¢å¤å¤„ç†**: æ”¯æŒä¸­æ–­åæ¢å¤ï¼Œé¿å…é‡å¤è®¡ç®—
- **æµå¼å¤„ç†**: å†…å­˜ä¼˜åŒ–ç”Ÿæˆå™¨æ”¯æŒå¤§æ–‡ä»¶çš„æµå¼å¤„ç†

### ğŸ“Š æ‰¹é‡é…ç½®
- **æ ·æœ¬é…ç½®**: ç”Ÿæˆå¤šä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬ä½¿ç”¨ç›¸åŒå‚æ•°ä½†ä¸åŒçš„å‘å°„å™¨åˆ†å¸ƒ
- **å˜é‡ç»„åˆ**: è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰å‚æ•°ç»„åˆçš„ä½œä¸š
- **åµŒå¥—é…ç½®**: æ”¯æŒç‚¹è®°æ³•ä¿®æ”¹åµŒå¥—é…ç½®å‚æ•°
- **çµæ´»é…ç½®**: åŸºç¡€é…ç½® + å˜é‡é…ç½®çš„æ¨¡å¼

### ğŸ” ç›‘æ§å’Œç®¡ç†
- **è¿›åº¦ç›‘æ§**: å®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦
- **çŠ¶æ€ä¿å­˜**: è‡ªåŠ¨ä¿å­˜å¤„ç†çŠ¶æ€ï¼Œæ”¯æŒæ¢å¤
- **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—
- **ç»“æœæ‘˜è¦**: å®Œæˆåæä¾›è¯¦ç»†çš„å¤„ç†æ‘˜è¦

## å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡é…ç½®æ–‡ä»¶

åˆ›å»ºæ‰¹é‡é…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚ `my_batch_config.json`ï¼‰ï¼š

```json
{
  "base_output_dir": "my_batch_output",
  "max_workers": 4,
  
  "base_config": {
    "zmap_path": "/path/to/your/patches.h5",
    "emitters": {
      "num_emitters": 1000,
      "frames": 50,
      "area_px": 1200.0,
      "intensity_mu": 10000.0,
      "intensity_sigma": 2000.0,
      "lifetime_avg": 2.5,
      "z_range_um": 1.0,
      "seed": 42,
      "no_plot": true
    },
    "tiff": {
      "roi_size": 1200,
      "use_direct_rendering": true,
      "add_noise": true,
      "noise_params": {
        "background": 100,
        "readout_noise": 10,
        "shot_noise": true
      }
    },
    "memory_optimization": {
      "chunk_size": 10,
      "enable_gc": true,
      "gc_frequency": 5
    }
  },
  
  "variables": {
    "emitters.num_emitters": [500, 1000, 2000],
    "tiff.noise_params.background": [50, 100, 200]
  }
}
```

### 2. è¿è¡Œæ‰¹é‡ç”Ÿæˆ

```bash
# æ ‡å‡†æ‰¹é‡ç”Ÿæˆ
python batch_tiff_generator.py --batch_config my_batch_config.json

# ä½¿ç”¨å†…å­˜ä¼˜åŒ–ç”Ÿæˆå™¨å¤„ç†å¤§æ–‡ä»¶
python memory_optimized_tiff_generator.py --h5 input.h5 --output output.tiff --chunk_size 5
```

### 3. æŸ¥çœ‹ç»“æœ

ç”Ÿæˆçš„æ–‡ä»¶å°†ä¿å­˜åœ¨ `my_batch_output/` ç›®å½•ä¸‹ï¼Œæ¯ä¸ªä½œä¸šæœ‰ç‹¬ç«‹çš„å­ç›®å½•ã€‚

## è¯¦ç»†é…ç½®è¯´æ˜

### åŸºç¡€é…ç½®ç»“æ„

#### æ ·æœ¬æ¨¡å¼ï¼ˆæ¨èç”¨äºç”Ÿæˆå¤šä¸ªç›¸åŒå‚æ•°çš„æ ·æœ¬ï¼‰
```json
{
  "description": "é…ç½®æè¿°",
  "base_output_dir": "è¾“å‡ºæ ¹ç›®å½•",
  "max_workers": 4,  // æœ€å¤§å¹¶è¡Œè¿›ç¨‹æ•°
  
  "base_config": {
    // æ‰€æœ‰æ ·æœ¬çš„åŸºç¡€é…ç½®
    "zmap_path": "å¿…éœ€ï¼šzmapæ–‡ä»¶è·¯å¾„",
    "emitters": { /* å‘å°„å™¨é…ç½® */ },
    "zernike": { /* Zernikeé…ç½® */ },
    "tiff": { /* TIFFè¾“å‡ºé…ç½® */ }
  },
  
  "sample_configs": {
    "num_samples": 5,           // ç”Ÿæˆ5ä¸ªæ ·æœ¬
    "frames_per_sample": 200,   // æ¯ä¸ªæ ·æœ¬200å¸§
    "sample_naming": "sample_{sample_id:03d}"  // æ ·æœ¬å‘½åæ ¼å¼
  }
}
```

#### å˜é‡æ¨¡å¼ï¼ˆç”¨äºå‚æ•°æ‰«æç ”ç©¶ï¼‰
```json
{
  "description": "é…ç½®æè¿°",
  "base_output_dir": "è¾“å‡ºæ ¹ç›®å½•",
  "max_workers": 4,  // æœ€å¤§å¹¶è¡Œè¿›ç¨‹æ•°
  
  "base_config": {
    // æ‰€æœ‰ä½œä¸šçš„åŸºç¡€é…ç½®
    "zmap_path": "å¿…éœ€ï¼šzmapæ–‡ä»¶è·¯å¾„",
    "emitters": { /* å‘å°„å™¨é…ç½® */ },
    "zernike": { /* Zernikeé…ç½® */ },
    "tiff": { /* TIFFè¾“å‡ºé…ç½® */ }
  },
  
  "variables": {
    // å˜é‡é…ç½®ï¼Œå°†ç”Ÿæˆæ‰€æœ‰ç»„åˆ
    "é…ç½®è·¯å¾„1": [å€¼1, å€¼2, å€¼3],
    "é…ç½®è·¯å¾„2": [å€¼A, å€¼B]
  }
}
```

### æ ·æœ¬é…ç½®è¯­æ³•

ç”¨äºç”Ÿæˆå¤šä¸ªä½¿ç”¨ç›¸åŒå‚æ•°ä½†ä¸åŒå‘å°„å™¨åˆ†å¸ƒçš„æ ·æœ¬ï¼š

```json
"sample_configs": {
  "num_samples": 5,           // ç”Ÿæˆ5ä¸ªæ ·æœ¬
  "frames_per_sample": 200,   // æ¯ä¸ªæ ·æœ¬200å¸§
  "sample_naming": "sample_{sample_id:03d}"  // æ ·æœ¬å‘½åæ ¼å¼
}
```

è¿™å°†ç”Ÿæˆ5ä¸ªæ ·æœ¬ï¼šsample_001, sample_002, ..., sample_005ï¼Œæ¯ä¸ªæ ·æœ¬åŒ…å«200å¸§ï¼Œä½¿ç”¨ä¸åŒçš„éšæœºç§å­ç¡®ä¿å‘å°„å™¨åˆ†å¸ƒä¸åŒã€‚

### å˜é‡é…ç½®è¯­æ³•

ä½¿ç”¨ç‚¹è®°æ³•æŒ‡å®šåµŒå¥—é…ç½®è·¯å¾„ï¼š

- `"emitters.num_emitters"`: ä¿®æ”¹ `emitters.num_emitters`
- `"tiff.noise_params.background"`: ä¿®æ”¹ `tiff.noise_params.background`
- `"emitters.frames"`: ä¿®æ”¹ `emitters.frames`

### å¸¸ç”¨é…ç½®ç¤ºä¾‹

#### å‘å°„å™¨å¯†åº¦ç ”ç©¶
```json
"variables": {
  "emitters.num_emitters": [100, 500, 1000, 2000, 5000],
  "emitters.frames": [20, 50, 100]
}
```

#### å™ªå£°æ°´å¹³ç ”ç©¶
```json
"variables": {
  "tiff.noise_params.background": [10, 50, 100, 200, 500],
  "tiff.noise_params.readout_noise": [5, 10, 20, 50]
}
```

#### å¼ºåº¦åˆ†å¸ƒç ”ç©¶
```json
"variables": {
  "emitters.intensity_mu": [2000, 5000, 10000, 20000],
  "emitters.intensity_sigma": [200, 500, 1000, 2000]
}
```

## å‘½ä»¤è¡Œé€‰é¡¹

```bash
python batch_tiff_generator.py [é€‰é¡¹]

å¿…éœ€å‚æ•°:
  --batch_config PATH    æ‰¹é‡é…ç½®æ–‡ä»¶è·¯å¾„

å¯é€‰å‚æ•°:
  --max_workers N        æœ€å¤§å¹¶è¡Œè¿›ç¨‹æ•°ï¼ˆè¦†ç›–é…ç½®æ–‡ä»¶è®¾ç½®ï¼‰
  --no_resume           ä¸æ¢å¤ä¹‹å‰çš„å¤„ç†ï¼Œé‡æ–°å¼€å§‹
  -h, --help            æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

## è¾“å‡ºç»“æ„

```
my_batch_output/
â”œâ”€â”€ batch_status.json              # å¤„ç†çŠ¶æ€æ–‡ä»¶
â”œâ”€â”€ job_0000_num_emitters_500_background_50/
â”‚   â”œâ”€â”€ emitters.h5
â”‚   â””â”€â”€ simulation.ome.tiff
â”œâ”€â”€ job_0001_num_emitters_500_background_100/
â”‚   â”œâ”€â”€ emitters.h5
â”‚   â””â”€â”€ simulation.ome.tiff
â”œâ”€â”€ job_0002_num_emitters_500_background_200/
â”‚   â”œâ”€â”€ emitters.h5
â”‚   â””â”€â”€ simulation.ome.tiff
â””â”€â”€ ...
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¹¶è¡Œè®¾ç½®
- **CPUå¯†é›†å‹**: è®¾ç½® `max_workers` ä¸ºCPUæ ¸å¿ƒæ•°
- **å†…å­˜é™åˆ¶**: å¦‚æœå†…å­˜ä¸è¶³ï¼Œå‡å°‘å¹¶è¡Œæ•°
- **I/Oå¯†é›†å‹**: å¯ä»¥è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°çš„1.5-2å€

### 2. é…ç½®ä¼˜åŒ–
- **å…³é—­å¯è§†åŒ–**: è®¾ç½® `"no_plot": true` èŠ‚çœæ—¶é—´
- **ä½¿ç”¨ç›´æ¥æ¸²æŸ“**: è®¾ç½® `"use_direct_rendering": true`
- **åˆç†çš„å›¾åƒå¤§å°**: é¿å…è¿‡å¤§çš„ `roi_size`
- **å†…å­˜ä¼˜åŒ–**: å¯¹äºå¤§æ–‡ä»¶ä½¿ç”¨å†…å­˜ä¼˜åŒ–ç”Ÿæˆå™¨
- **æµå¼å¤„ç†**: è°ƒæ•´ `chunk_size` å‚æ•°æ§åˆ¶å†…å­˜ä½¿ç”¨

### 3. æ‰¹é‡å¤§å°
- **å°æ‰¹é‡**: ä¾¿äºè°ƒè¯•å’Œå¿«é€ŸéªŒè¯
- **å¤§æ‰¹é‡**: å……åˆ†åˆ©ç”¨å¹¶è¡Œå¤„ç†ä¼˜åŠ¿
- **åˆ†é˜¶æ®µ**: å¯ä»¥åˆ†å¤šä¸ªæ‰¹æ¬¡è¿è¡Œ

## é”™è¯¯å¤„ç†å’Œæ¢å¤

### è‡ªåŠ¨æ¢å¤
æ‰¹é‡ç”Ÿæˆå™¨ä¼šè‡ªåŠ¨ä¿å­˜å¤„ç†çŠ¶æ€ï¼Œå¦‚æœä¸­æ–­åé‡æ–°è¿è¡Œï¼Œä¼šè‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„ä½œä¸šã€‚

### æ‰‹åŠ¨é‡ç½®
å¦‚æœéœ€è¦é‡æ–°å¼€å§‹æ‰€æœ‰ä½œä¸šï¼š
```bash
python batch_tiff_generator.py --batch_config my_batch_config.json --no_resume
```

### æŸ¥çœ‹å¤±è´¥ä½œä¸š
å¤„ç†å®Œæˆåï¼Œæ‘˜è¦ä¼šæ˜¾ç¤ºå¤±è´¥çš„ä½œä¸šè¯¦æƒ…ã€‚å¯ä»¥æ£€æŸ¥ `batch_status.json` æ–‡ä»¶è·å–æ›´å¤šä¿¡æ¯ã€‚

## ç›‘æ§å’Œè°ƒè¯•

### å®æ—¶ç›‘æ§
- è¿›åº¦æ˜¾ç¤ºï¼š`è¿›åº¦: 5/20 (25.0%)`
- ä½œä¸šçŠ¶æ€ï¼š`âœ“ ä½œä¸š job_0001 å®Œæˆ` æˆ– `âœ— ä½œä¸š job_0002 å¤±è´¥`

### æ—¥å¿—ä¿¡æ¯
æ¯ä¸ªä½œä¸šçš„è¯¦ç»†æ—¥å¿—ä¼šå®æ—¶æ˜¾ç¤ºï¼ŒåŒ…æ‹¬ï¼š
- å‘å°„å™¨ç”Ÿæˆè¿›åº¦
- Zernikeç³»æ•°è®¡ç®—çŠ¶æ€
- TIFFç”Ÿæˆä¿¡æ¯

### çŠ¶æ€æ–‡ä»¶
`batch_status.json` åŒ…å«ï¼š
- å·²å®Œæˆä½œä¸šåˆ—è¡¨
- å¤±è´¥ä½œä¸šè¯¦æƒ…
- å¤„ç†æ—¶é—´ç»Ÿè®¡

## ç¤ºä¾‹å·¥ä½œæµ

### 1. å‚æ•°æ‰«æç ”ç©¶
```bash
# 1. åˆ›å»ºé…ç½®æ–‡ä»¶
cp batch_config_example.json my_study_config.json

# 2. ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®ä½ çš„å‚æ•°èŒƒå›´
vim my_study_config.json

# 3. è¿è¡Œæ‰¹é‡ç”Ÿæˆ
python batch_tiff_generator.py --batch_config my_study_config.json

# 4. åˆ†æç»“æœ
ls batch_output_*/*/simulation.ome.tiff
```

### 2. å¿«é€Ÿæµ‹è¯•
```bash
# ä½¿ç”¨ç®€å•é…ç½®è¿›è¡Œå¿«é€Ÿæµ‹è¯•
python batch_tiff_generator.py --batch_config batch_config_simple.json --max_workers 2

# æµ‹è¯•å†…å­˜ä¼˜åŒ–ç”Ÿæˆå™¨
python memory_optimized_tiff_generator.py --h5 test.h5 --output test.tiff --chunk_size 5
```

## ä¸åŸå§‹è„šæœ¬çš„æ¯”è¾ƒ

| ç‰¹æ€§ | åŸå§‹è„šæœ¬ | æ‰¹é‡ç”Ÿæˆå™¨ | å†…å­˜ä¼˜åŒ–ç”Ÿæˆå™¨ |
|------|----------|------------|----------------|
| å¹¶è¡Œå¤„ç† | âŒ | âœ… | âŒ |
| æ‰¹é‡é…ç½® | âŒ | âœ… | âŒ |
| å¯æ¢å¤å¤„ç† | âŒ | âœ… | âŒ |
| è¿›åº¦ç›‘æ§ | åŸºç¡€ | è¯¦ç»† | è¯¦ç»† |
| å†…å­˜ä¼˜åŒ– | ä¸€èˆ¬ | ä¼˜åŒ– | é«˜åº¦ä¼˜åŒ– |
| æµå¼å¤„ç† | âŒ | âŒ | âœ… |
| å¤§æ–‡ä»¶æ”¯æŒ | âŒ | æœ‰é™ | âœ… |
| é”™è¯¯å¤„ç† | åŸºç¡€ | å®Œå–„ | å®Œå–„ |
| é…ç½®çµæ´»æ€§ | ä¸€èˆ¬ | é«˜ | ä¸­ç­‰ |

### æ€§èƒ½æå‡

æ ¹æ®æ€§èƒ½æµ‹è¯•ç»“æœï¼š
- **æ‰¹é‡ç”Ÿæˆå™¨**: ç›¸æ¯”åŸå§‹æ–¹æ³•æå‡ 30-50% çš„å¤„ç†é€Ÿåº¦
- **å†…å­˜ä¼˜åŒ–ç”Ÿæˆå™¨**: å†…å­˜ä½¿ç”¨å‡å°‘ 60-80%ï¼Œæ”¯æŒæ›´å¤§çš„æ•°æ®é›†
- **å¹¶è¡Œå¤„ç†**: åœ¨å¤šæ ¸ç³»ç»Ÿä¸Šå¯è·å¾—è¿‘çº¿æ€§çš„æ€§èƒ½æå‡

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜ä¸è¶³**
   - å‡å°‘ `max_workers`
   - å‡å°‘ `roi_size`
   - å‡å°‘ `num_emitters`

2. **æ‰¾ä¸åˆ°zmapæ–‡ä»¶**
   - æ£€æŸ¥ `zmap_path` æ˜¯å¦æ­£ç¡®
   - ä½¿ç”¨ç»å¯¹è·¯å¾„

3. **æƒé™é”™è¯¯**
   - æ£€æŸ¥è¾“å‡ºç›®å½•æƒé™
   - ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´

4. **è¿›ç¨‹å¡ä½**
   - æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å†…å­˜
   - å°è¯•å‡å°‘å¹¶è¡Œæ•°
   - æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

### è°ƒè¯•æŠ€å·§

1. **å…ˆç”¨å°é…ç½®æµ‹è¯•**
2. **æ£€æŸ¥å•ä¸ªä½œä¸šæ˜¯å¦æ­£å¸¸**
3. **æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯**
4. **ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨**

## æ€»ç»“

æ‰¹é‡TIFFç”Ÿæˆå™¨æä¾›äº†ä¸€ä¸ªé«˜æ•ˆã€çµæ´»çš„æ–¹å¼æ¥ç”Ÿæˆå¤§é‡ä¸åŒå‚æ•°é…ç½®çš„TIFFæ–‡ä»¶ã€‚é€šè¿‡åˆç†çš„é…ç½®å’Œä¼˜åŒ–ï¼Œå¯ä»¥æ˜¾è‘—æé«˜æ•°æ®ç”Ÿæˆæ•ˆç‡ï¼Œç‰¹åˆ«é€‚åˆå‚æ•°æ‰«æç ”ç©¶å’Œå¤§è§„æ¨¡æ•°æ®é›†ç”Ÿæˆã€‚